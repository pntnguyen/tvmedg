<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>tvmedg package</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="function_files/libs/clipboard/clipboard.min.js"></script>
<script src="function_files/libs/quarto-html/quarto.js"></script>
<script src="function_files/libs/quarto-html/popper.min.js"></script>
<script src="function_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="function_files/libs/quarto-html/anchor.min.js"></script>
<link href="function_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="function_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="function_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="function_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="function_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">

<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">tvmedg package</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="import-data" class="level1">
<h1>Import data</h1>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../Data/tvmed_dat100.RDS"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dat0 <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id mm Ap Mp L1       L2        L3 Yp      age sex ow risk lastid
1  1  1  0  0  0 100.0000  80.00000  0 10.92764   1  1    0      0
2  1  2  0  0  0 130.6644  88.06184  0 10.92764   1  1    0      0
3  1  3  0  0  0 125.2740  97.63087  0 10.92764   1  1    0      0
4  1  4  0  0  0 135.2596 112.20273  0 10.92764   1  1    0      0
5  1  5  0  0  0 124.3786 108.05454  0 10.92764   1  1    0      0
6  1  6  0  0  0 141.4882 123.36927  0 10.92764   1  1    0      0</code></pre>
</div>
</div>
</section>
<section id="df_prep-function" class="level1">
<h1>df_prep function</h1>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_prep <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> data<span class="sc">$</span>id)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Baseline characteristics</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v1 <span class="ot">&lt;-</span> data<span class="sc">$</span>age</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v2 <span class="ot">&lt;-</span> data<span class="sc">$</span>sex</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v3 <span class="ot">&lt;-</span> data<span class="sc">$</span>ow</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v4 <span class="ot">&lt;-</span> data<span class="sc">$</span>risk</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Time-varying treatment</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>A <span class="ot">&lt;-</span> data<span class="sc">$</span>Ap</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Al1 <span class="ot">&lt;-</span> data<span class="sc">$</span>A_lag1</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Al2 <span class="ot">&lt;-</span> data<span class="sc">$</span>A_lag2</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># time-dependent covariate</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L1</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T1l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L1_lag1</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T1l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L1_lag2</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L2</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T2l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L2_lag1</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T2l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L2_lag2</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T3 <span class="ot">&lt;-</span> data<span class="sc">$</span>L3</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T3l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L3_lag1</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T3l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L3_lag2</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mediator</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>M1 <span class="ot">&lt;-</span> data<span class="sc">$</span>Mp</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>M1l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>M_lag1</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>M1l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>M_lag2</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># outcomes</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Yp</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Time</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>j <span class="ot">&lt;-</span> data<span class="sc">$</span>mm</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="process-data-function" class="level1">
<h1>Process data function</h1>
<p>Function này gồm các argument mà user sẽ nhập vào gồm <strong>fix</strong>: time_fixed covariates, <strong>expo</strong>: exposure variable, <strong>med</strong>: mediator variables, <strong>lag</strong>: lag, <strong>outc</strong>: outcome variable, <strong>data</strong>: data</p>
<p>Khi sử dụng function này user sẽ nhập các variables và outcome sẽ trả về theo lag</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>process_data <span class="ot">&lt;-</span> <span class="cf">function</span>(fix,expo,med,tvar,lag,outc,time,data){</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of time-fixed variables</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  name_v <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"v"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fix))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> data<span class="sc">$</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(data[,fix]) <span class="sc">%&gt;%</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"id"</span>,name_v))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of exposure variables  </span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  name_e <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(expo))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of mediator variables  </span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  name_me <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"M"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(med))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of time-varying variables  </span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  name_tvar <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"L"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tvar))</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>lag){</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="do">## column name of lag effect on exposure variable</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    co_ex <span class="ot">&lt;-</span> <span class="fu">paste0</span>(name_e,<span class="st">"l"</span>,i)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    co_me <span class="ot">&lt;-</span> <span class="fu">paste0</span>(name_me,<span class="st">"l"</span>,i)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    co_tvar <span class="ot">&lt;-</span> <span class="fu">paste0</span>(name_tvar,<span class="st">"l"</span>,i)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(name_e)){</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    out[,name_e[k]] <span class="ot">&lt;-</span> data[,expo[k]]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    name_ep <span class="ot">&lt;-</span> {{co_ex}}[k]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span> </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        {{name_ep}} <span class="sc">:</span><span class="er">=</span> <span class="fu">lag</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_e[k]),<span class="at">n=</span>i,<span class="at">default =</span> data[<span class="dv">1</span>,expo[k]])</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(name_me)){</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    out[,name_me[k]] <span class="ot">&lt;-</span> data[,med[k]]</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    name_med <span class="ot">&lt;-</span> {{co_me}}[k]</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span> </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        {{name_med}} <span class="sc">:</span><span class="er">=</span> <span class="fu">lag</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_me[k]),<span class="at">n=</span>i,<span class="at">default =</span> data[<span class="dv">1</span>,med[k]])</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      ) </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    }  </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(name_tvar)){</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    out[,name_tvar[k]] <span class="ot">&lt;-</span> data[,tvar[k]]</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    name_tv <span class="ot">&lt;-</span> {{co_tvar}}[k]</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span> </span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        {{name_tv}} <span class="sc">:</span><span class="er">=</span> <span class="fu">lag</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_tvar[k]),<span class="at">n=</span>i,<span class="at">default =</span> data[<span class="dv">1</span>,tvar[k]])</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="do">## outcome variable</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  out<span class="sc">$</span>Y <span class="ot">&lt;-</span> data[,outc]</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  <span class="do">## time variable</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>  out<span class="sc">$</span>j <span class="ot">&lt;-</span> data[,time]</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  out <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="comparison" class="level2">
<h2 class="anchored" data-anchor-id="comparison">Comparison</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p>a Long’s code</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag1 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag2 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag1 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag2 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag1 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag2 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag1 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag2 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag1 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">80</span>),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag2 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">80</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">df_prep</span>()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id       v1 v2 v3 v4 A Al1 Al2 T1 T1l1 T1l2       T2     T2l1     T2l2
1  1 10.92764  1  1  0 0   0   0  0    0    0 100.0000 100.0000 100.0000
2  1 10.92764  1  1  0 0   0   0  0    0    0 130.6644 100.0000 100.0000
3  1 10.92764  1  1  0 0   0   0  0    0    0 125.2740 130.6644 100.0000
4  1 10.92764  1  1  0 0   0   0  0    0    0 135.2596 125.2740 130.6644
5  1 10.92764  1  1  0 0   0   0  0    0    0 124.3786 135.2596 125.2740
6  1 10.92764  1  1  0 0   0   0  0    0    0 141.4882 124.3786 135.2596
         T3      T3l1      T3l2 M1 M1l1 M1l2 Y j
1  80.00000  80.00000  80.00000  0    0    0 0 1
2  88.06184  80.00000  80.00000  0    0    0 0 2
3  97.63087  88.06184  80.00000  0    0    0 0 3
4 112.20273  97.63087  88.06184  0    0    0 0 4
5 108.05454 112.20273  97.63087  0    0    0 0 5
6 123.36927 108.05454 112.20273  0    0    0 0 6</code></pre>
</div>
</div>
</div><div class="column" style="width:50%;">
<p>Function</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## example lag = 3</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data_pro <span class="ot">&lt;-</span> <span class="fu">process_data</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>data_pro <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id       v1 v2 v3 v4 A1 A1l1 M1 M1l1 L1 L1l1       L2     L2l1        L3
1  1 10.92764  1  1  0  0    0  0    0  0    0 100.0000 100.0000  80.00000
2  1 10.92764  1  1  0  0    0  0    0  0    0 130.6644 100.0000  88.06184
3  1 10.92764  1  1  0  0    0  0    0  0    0 125.2740 130.6644  97.63087
4  1 10.92764  1  1  0  0    0  0    0  0    0 135.2596 125.2740 112.20273
5  1 10.92764  1  1  0  0    0  0    0  0    0 124.3786 135.2596 108.05454
6  1 10.92764  1  1  0  0    0  0    0  0    0 141.4882 124.3786 123.36927
       L3l1 A1l2 M1l2 L1l2     L2l2      L3l2 Y j
1  80.00000    0    0    0 100.0000  80.00000 0 1
2  80.00000    0    0    0 100.0000  80.00000 0 2
3  88.06184    0    0    0 100.0000  80.00000 0 3
4  97.63087    0    0    0 130.6644  88.06184 0 4
5 112.20273    0    0    0 125.2740  97.63087 0 5
6 108.05454    0    0    0 135.2596 112.20273 0 6</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="test" class="level2">
<h2 class="anchored" data-anchor-id="test">Test</h2>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"process_data function"</span>, {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## id, v1 - v4</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)],data_pro[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## exposure variables</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"A"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"A1"</span>)])</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"Al1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"A1l1"</span>)])</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"Al2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"A1l2"</span>)])</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## time-dependent covariate</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L1"</span>)])</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L2"</span>)])</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T3"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L3"</span>)])</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## time-dependent covariate + lag</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T1l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L1l1"</span>)])</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T2l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L2l1"</span>)])</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T3l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L3l1"</span>)])</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T1l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L1l2"</span>)])</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T2l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L2l2"</span>)])</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T3l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L3l2"</span>)])</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Mediator</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"M1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"M1"</span>)])</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"M1l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"M1l1"</span>)])</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"M1l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"M1l2"</span>)])</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## outcome and time</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"Y"</span>,<span class="st">"j"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"Y"</span>,<span class="st">"j"</span>)])</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
</div>
<section id="another-example" class="level3">
<h3 class="anchored" data-anchor-id="another-example">Another example</h3>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## lag = 3</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">process_data</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">3</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id       v1 v2 v3 v4 A1 A1l1 M1 M1l1 L1 L1l1       L2     L2l1        L3
1  1 10.92764  1  1  0  0    0  0    0  0    0 100.0000 100.0000  80.00000
2  1 10.92764  1  1  0  0    0  0    0  0    0 130.6644 100.0000  88.06184
3  1 10.92764  1  1  0  0    0  0    0  0    0 125.2740 130.6644  97.63087
4  1 10.92764  1  1  0  0    0  0    0  0    0 135.2596 125.2740 112.20273
5  1 10.92764  1  1  0  0    0  0    0  0    0 124.3786 135.2596 108.05454
6  1 10.92764  1  1  0  0    0  0    0  0    0 141.4882 124.3786 123.36927
       L3l1 A1l2 M1l2 L1l2     L2l2      L3l2 A1l3 M1l3 L1l3     L2l3     L3l3
1  80.00000    0    0    0 100.0000  80.00000    0    0    0 100.0000 80.00000
2  80.00000    0    0    0 100.0000  80.00000    0    0    0 100.0000 80.00000
3  88.06184    0    0    0 100.0000  80.00000    0    0    0 100.0000 80.00000
4  97.63087    0    0    0 130.6644  88.06184    0    0    0 100.0000 80.00000
5 112.20273    0    0    0 125.2740  97.63087    0    0    0 130.6644 88.06184
6 108.05454    0    0    0 135.2596 112.20273    0    0    0 125.2740 97.63087
  Y j
1 0 1
2 0 2
3 0 3
4 0 4
5 0 5
6 0 6</code></pre>
</div>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## assump risk is another exposure variables</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">## This time, risk become A2 variable</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">process_data</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>,<span class="st">"risk"</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id       v1 v2 v3 A1 A1l1 A2 A2l1 M1 M1l1 L1 L1l1       L2     L2l1        L3
1  1 10.92764  1  1  0    0  0    0  0    0  0    0 100.0000 100.0000  80.00000
2  1 10.92764  1  1  0    0  0    0  0    0  0    0 130.6644 100.0000  88.06184
3  1 10.92764  1  1  0    0  0    0  0    0  0    0 125.2740 130.6644  97.63087
4  1 10.92764  1  1  0    0  0    0  0    0  0    0 135.2596 125.2740 112.20273
5  1 10.92764  1  1  0    0  0    0  0    0  0    0 124.3786 135.2596 108.05454
6  1 10.92764  1  1  0    0  0    0  0    0  0    0 141.4882 124.3786 123.36927
       L3l1 A1l2 A2l2 M1l2 L1l2     L2l2      L3l2 Y j
1  80.00000    0    0    0    0 100.0000  80.00000 0 1
2  80.00000    0    0    0    0 100.0000  80.00000 0 2
3  88.06184    0    0    0    0 100.0000  80.00000 0 3
4  97.63087    0    0    0    0 130.6644  88.06184 0 4
5 112.20273    0    0    0    0 125.2740  97.63087 0 5
6 108.05454    0    0    0    0 135.2596 112.20273 0 6</code></pre>
</div>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## assump exposure is continuous variables, in this case is L3</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">process_data</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>,<span class="st">"L3"</span>),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id       v1 v2 v3 v4 A1 A1l1        A2      A2l1 M1 M1l1 L1 L1l1       L2
1  1 10.92764  1  1  0  0    0  80.00000  80.00000  0    0  0    0 100.0000
2  1 10.92764  1  1  0  0    0  88.06184  80.00000  0    0  0    0 130.6644
3  1 10.92764  1  1  0  0    0  97.63087  88.06184  0    0  0    0 125.2740
4  1 10.92764  1  1  0  0    0 112.20273  97.63087  0    0  0    0 135.2596
5  1 10.92764  1  1  0  0    0 108.05454 112.20273  0    0  0    0 124.3786
6  1 10.92764  1  1  0  0    0 123.36927 108.05454  0    0  0    0 141.4882
      L2l1 A1l2      A2l2 M1l2 L1l2     L2l2 Y j
1 100.0000    0  80.00000    0    0 100.0000 0 1
2 100.0000    0  80.00000    0    0 100.0000 0 2
3 130.6644    0  80.00000    0    0 100.0000 0 3
4 125.2740    0  88.06184    0    0 130.6644 0 4
5 135.2596    0  97.63087    0    0 125.2740 0 5
6 124.3786    0 112.20273    0    0 135.2596 0 6</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="function-to-centering-and-scaling-the-time-scale-variable" class="level1">
<h1>Function to centering and scaling the time-scale variable</h1>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>cen_and_scale <span class="ot">&lt;-</span> <span class="cf">function</span>(time){</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  j_out <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  jj <span class="ot">&lt;-</span> time <span class="sc">%&gt;%</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale</span>() </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  j_out[[<span class="st">"jj"</span>]] <span class="ot">&lt;-</span> jj <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  j_out[[<span class="st">"mean_j"</span>]] <span class="ot">&lt;-</span> <span class="fu">attributes</span>(jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:center</span><span class="st">`</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  j_out[[<span class="st">"sd_j"</span>]] <span class="ot">&lt;-</span> <span class="fu">attributes</span>(jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:scale</span><span class="st">`</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  j_out</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Assump seed = 0, not doing boostrap</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>boot <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_lag1 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_lag2 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">M_lag1 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">M_lag2 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1_lag1 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1_lag2 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_lag1 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_lag2 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3_lag1 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">80</span>),</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3_lag2 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">80</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">df_prep</span>()</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>boot<span class="sc">$</span>jj <span class="ot">&lt;-</span> <span class="fu">scale</span>(boot<span class="sc">$</span>j)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>mean_j <span class="ot">&lt;-</span> <span class="fu">attributes</span>(boot<span class="sc">$</span>jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:center</span><span class="st">`</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>sd_j <span class="ot">&lt;-</span> <span class="fu">attributes</span>(boot<span class="sc">$</span>jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:scale</span><span class="st">`</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>boot<span class="sc">$</span>jj <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(boot<span class="sc">$</span>jj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div><div class="column" style="width:50%;">
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>boot2 <span class="ot">&lt;-</span> <span class="fu">cen_and_scale</span>(data_pro<span class="sc">$</span>j)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
<section id="test-1" class="level3">
<h3 class="anchored" data-anchor-id="test-1">Test</h3>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"cen and scale function"</span>, {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(boot<span class="sc">$</span>jj,boot2<span class="sc">$</span>jj)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(mean_j,boot2<span class="sc">$</span>mean_j)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(sd_j,boot2<span class="sc">$</span>sd_j)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎉</code></pre>
</div>
</div>
</section>
</section>
<section id="write-formula-function" class="level1">
<h1>write formula function</h1>
<p>Assumption ở bước này là sau khi data đã được process và tên các column đã được thống nhất theo tiêu chuẩn chung của package. Khúc này em chưa viết function chỉ viết các lệnh lẻ để thể hiện workflow của function</p>
<p>Em đang bị stuck ở:</p>
<ul>
<li><p>Em chưa viết được formula cho L(t), do L1 không bao gồm L2+L3, L2 thì bao gồm L1, và L3 bao gồm L1+L2. Em chưa tìm ra được quy luật để viết</p></li>
<li><p>Phần splines phía sau sẽ để user define degree of freedom và paste vào trong formula, nhưng em chưa làm để đỡ rối</p></li>
</ul>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"A"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>tf <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"v"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>tva <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"L"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>mediator <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"M"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"Y"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>timee <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"j"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">## assump các arguments này được input vào function data_processed </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fix <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>expo <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Ap"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>med <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Mp"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>tvar <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>outc <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Yp"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>lag <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>time <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"mm"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="do">## column names of exposure variables</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>name_e <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(expo))</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="do">## column names of mediator variables  </span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>name_me <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"M"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(med))</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="do">## column names of time-varying variables  </span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>name_tvar <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"L"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tvar))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="formula-for-mt" class="level2">
<h2 class="anchored" data-anchor-id="formula-for-mt">Formula for M(t)</h2>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">## formula for M(t)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># l(t-1)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>l_tm1 <span class="ot">&lt;-</span> tva[<span class="sc">!</span>tva <span class="sc">%in%</span> name_tvar]</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>l_tm1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "L1l1" "L2l1" "L3l1" "L1l2" "L2l2" "L3l2"</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>formular_mt <span class="ot">&lt;-</span> <span class="fu">paste</span>(mediator[<span class="dv">1</span>],<span class="st">"~"</span>,<span class="fu">paste</span>(<span class="fu">c</span>(eps,mediator[<span class="sc">-</span><span class="dv">1</span>],l_tm1,tf),<span class="at">collapse =</span> <span class="st">" + "</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>formular_mt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "M1 ~ A1 + A1l1 + A1l2 + M1l1 + M1l2 + L1l1 + L2l1 + L3l1 + L1l2 + L2l2 + L3l2 + v1 + v2 + v3 + v4"</code></pre>
</div>
</div>
<section id="test-2" class="level3">
<h3 class="anchored" data-anchor-id="test-2">Test</h3>
<p>Assump chưa bao gồm j</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"test data formular for M(t)"</span>, {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## a Long code</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  boot <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag1 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag2 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag1 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag2 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag1 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag2 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag1 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag2 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag1 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">80</span>),</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag2 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">80</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">df_prep</span>()</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  aLong_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(M1 <span class="sc">~</span> A <span class="sc">+</span> Al1 <span class="sc">+</span> Al2 <span class="sc">+</span> M1l1 <span class="sc">+</span> M1l2 <span class="sc">+</span> T1l1 <span class="sc">+</span> T1l2 <span class="sc">+</span> T2l1 <span class="sc">+</span> T2l2 <span class="sc">+</span> T3l1 <span class="sc">+</span> T3l2 <span class="sc">+</span> </span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>                      v1 <span class="sc">+</span> v2 <span class="sc">+</span> v3 <span class="sc">+</span> v4, <span class="at">family =</span> binomial, <span class="at">data =</span> boot)<span class="sc">|&gt;</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Nguyen's code</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  data_pro <span class="ot">&lt;-</span> <span class="fu">process_data</span>(</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>),</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>  N_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(formular_mt ,<span class="at">family =</span> binomial, <span class="at">data =</span> data_pro) <span class="sc">|&gt;</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">min</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">min</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">max</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">max</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">mean</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">mean</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">sd</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">sd</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 🎊</code></pre>
</div>
</div>
</section>
</section>
<section id="formula-for-y" class="level2">
<h2 class="anchored" data-anchor-id="formula-for-y">formula for Y</h2>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>formular_y <span class="ot">&lt;-</span> <span class="fu">paste</span>(outcome,<span class="st">"~"</span>,<span class="fu">paste</span>(<span class="fu">c</span>(eps,mediator,tva,tf),<span class="at">collapse =</span> <span class="st">" + "</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>formular_y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Y ~ A1 + A1l1 + A1l2 + M1 + M1l1 + M1l2 + L1 + L1l1 + L2 + L2l1 + L3 + L3l1 + L1l2 + L2l2 + L3l2 + v1 + v2 + v3 + v4"</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"test data formular for Y"</span>, {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  N_model_y <span class="ot">&lt;-</span> <span class="fu">glm</span>(formular_y ,<span class="at">family =</span> binomial, <span class="at">data =</span> data_pro) <span class="sc">|&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  aLong_model_y <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> Al1 <span class="sc">+</span> Al2 <span class="sc">+</span> M1 <span class="sc">+</span> M1l1 <span class="sc">+</span> M1l2 <span class="sc">+</span> T1 <span class="sc">+</span> T1l1 <span class="sc">+</span> T1l2 <span class="sc">+</span> T2 <span class="sc">+</span> T2l1 <span class="sc">+</span> T2l2 <span class="sc">+</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                       T3 <span class="sc">+</span> T3l1 <span class="sc">+</span> T3l2 <span class="sc">+</span>  v1 <span class="sc">+</span> v2 <span class="sc">+</span> v3 <span class="sc">+</span> v4, </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family =</span> binomial, <span class="at">data =</span> boot) <span class="sc">|&gt;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">min</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">min</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">max</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">max</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">mean</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">mean</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">sd</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">sd</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Test passed 😸</code></pre>
</div>
</div>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb35" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "tvmedg package"</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">    page-layout: full</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="an">message:</span><span class="co"> false</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="an">warning:</span><span class="co"> false</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="fu"># Import data</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../Data/tvmed_dat100.RDS"</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>dat0 <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="fu"># df_prep function</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>df_prep <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> data<span class="sc">$</span>id)</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Baseline characteristics</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v1 <span class="ot">&lt;-</span> data<span class="sc">$</span>age</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v2 <span class="ot">&lt;-</span> data<span class="sc">$</span>sex</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v3 <span class="ot">&lt;-</span> data<span class="sc">$</span>ow</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>v4 <span class="ot">&lt;-</span> data<span class="sc">$</span>risk</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Time-varying treatment</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>A <span class="ot">&lt;-</span> data<span class="sc">$</span>Ap</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Al1 <span class="ot">&lt;-</span> data<span class="sc">$</span>A_lag1</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Al2 <span class="ot">&lt;-</span> data<span class="sc">$</span>A_lag2</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># time-dependent covariate</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L1</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T1l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L1_lag1</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T1l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L1_lag2</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L2</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T2l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L2_lag1</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T2l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L2_lag2</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T3 <span class="ot">&lt;-</span> data<span class="sc">$</span>L3</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T3l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>L3_lag1</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>T3l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>L3_lag2</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mediator</span></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>M1 <span class="ot">&lt;-</span> data<span class="sc">$</span>Mp</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>M1l1 <span class="ot">&lt;-</span> data<span class="sc">$</span>M_lag1</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>M1l2 <span class="ot">&lt;-</span> data<span class="sc">$</span>M_lag2</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># outcomes</span></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Yp</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Time</span></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>j <span class="ot">&lt;-</span> data<span class="sc">$</span>mm</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a><span class="fu"># Process data function</span></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>Function này gồm các argument mà user sẽ nhập vào gồm **fix**: time_fixed covariates, **expo**: exposure variable, **med**: mediator variables, **lag**: lag, **outc**: outcome variable, **data**: data</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>Khi sử dụng function này user sẽ nhập các variables và outcome sẽ trả về theo lag</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>process_data <span class="ot">&lt;-</span> <span class="cf">function</span>(fix,expo,med,tvar,lag,outc,time,data){</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of time-fixed variables</span></span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>  name_v <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"v"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fix))</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> data<span class="sc">$</span>id) <span class="sc">%&gt;%</span> </span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(data[,fix]) <span class="sc">%&gt;%</span> </span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>    magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"id"</span>,name_v))</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of exposure variables  </span></span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>  name_e <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(expo))</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of mediator variables  </span></span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>  name_me <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"M"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(med))</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>  <span class="do">## column names of time-varying variables  </span></span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>  name_tvar <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"L"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tvar))</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>lag){</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>    <span class="do">## column name of lag effect on exposure variable</span></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>    co_ex <span class="ot">&lt;-</span> <span class="fu">paste0</span>(name_e,<span class="st">"l"</span>,i)</span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>    co_me <span class="ot">&lt;-</span> <span class="fu">paste0</span>(name_me,<span class="st">"l"</span>,i)</span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>    co_tvar <span class="ot">&lt;-</span> <span class="fu">paste0</span>(name_tvar,<span class="st">"l"</span>,i)</span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(name_e)){</span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>    out[,name_e[k]] <span class="ot">&lt;-</span> data[,expo[k]]</span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>    name_ep <span class="ot">&lt;-</span> {{co_ex}}[k]</span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span> </span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>        {{name_ep}} <span class="sc">:</span><span class="er">=</span> <span class="fu">lag</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_e[k]),<span class="at">n=</span>i,<span class="at">default =</span> data[<span class="dv">1</span>,expo[k]])</span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(name_me)){</span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>    out[,name_me[k]] <span class="ot">&lt;-</span> data[,med[k]]</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>    name_med <span class="ot">&lt;-</span> {{co_me}}[k]</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span> </span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>        {{name_med}} <span class="sc">:</span><span class="er">=</span> <span class="fu">lag</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_me[k]),<span class="at">n=</span>i,<span class="at">default =</span> data[<span class="dv">1</span>,med[k]])</span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>      ) </span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a>    }  </span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(name_tvar)){</span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>    out[,name_tvar[k]] <span class="ot">&lt;-</span> data[,tvar[k]]</span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>    name_tv <span class="ot">&lt;-</span> {{co_tvar}}[k]</span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span> </span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a>        {{name_tv}} <span class="sc">:</span><span class="er">=</span> <span class="fu">lag</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_tvar[k]),<span class="at">n=</span>i,<span class="at">default =</span> data[<span class="dv">1</span>,tvar[k]])</span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a>  <span class="do">## outcome variable</span></span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a>  out<span class="sc">$</span>Y <span class="ot">&lt;-</span> data[,outc]</span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a>  <span class="do">## time variable</span></span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a>  out<span class="sc">$</span>j <span class="ot">&lt;-</span> data[,time]</span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a>  out <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>()</span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a>}  </span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-165"><a href="#cb35-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison</span></span>
<span id="cb35-166"><a href="#cb35-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a>::: columns</span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a>::: {.column width="50%"}</span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-170"><a href="#cb35-170" aria-hidden="true" tabindex="-1"></a>a Long's code</span>
<span id="cb35-171"><a href="#cb35-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-174"><a href="#cb35-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-175"><a href="#cb35-175" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span> </span>
<span id="cb35-176"><a href="#cb35-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb35-177"><a href="#cb35-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-178"><a href="#cb35-178" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag1 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-179"><a href="#cb35-179" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag2 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-180"><a href="#cb35-180" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag1 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-181"><a href="#cb35-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag2 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-182"><a href="#cb35-182" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag1 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-183"><a href="#cb35-183" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag2 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-184"><a href="#cb35-184" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag1 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb35-185"><a href="#cb35-185" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag2 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb35-186"><a href="#cb35-186" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag1 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">80</span>),</span>
<span id="cb35-187"><a href="#cb35-187" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag2 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">80</span>)</span>
<span id="cb35-188"><a href="#cb35-188" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">df_prep</span>()</span>
<span id="cb35-189"><a href="#cb35-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-190"><a href="#cb35-190" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb35-191"><a href="#cb35-191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-192"><a href="#cb35-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-193"><a href="#cb35-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-194"><a href="#cb35-194" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-195"><a href="#cb35-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-196"><a href="#cb35-196" aria-hidden="true" tabindex="-1"></a>::: {.column width="50%"}</span>
<span id="cb35-197"><a href="#cb35-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-198"><a href="#cb35-198" aria-hidden="true" tabindex="-1"></a>Function</span>
<span id="cb35-199"><a href="#cb35-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-202"><a href="#cb35-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-203"><a href="#cb35-203" aria-hidden="true" tabindex="-1"></a><span class="do">## example lag = 3</span></span>
<span id="cb35-204"><a href="#cb35-204" aria-hidden="true" tabindex="-1"></a>data_pro <span class="ot">&lt;-</span> <span class="fu">process_data</span>(</span>
<span id="cb35-205"><a href="#cb35-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb35-206"><a href="#cb35-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>),</span>
<span id="cb35-207"><a href="#cb35-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb35-208"><a href="#cb35-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb35-209"><a href="#cb35-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb35-210"><a href="#cb35-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb35-211"><a href="#cb35-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb35-212"><a href="#cb35-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb35-213"><a href="#cb35-213" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb35-214"><a href="#cb35-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-215"><a href="#cb35-215" aria-hidden="true" tabindex="-1"></a>data_pro <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb35-216"><a href="#cb35-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-217"><a href="#cb35-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-218"><a href="#cb35-218" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-219"><a href="#cb35-219" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-220"><a href="#cb35-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-221"><a href="#cb35-221" aria-hidden="true" tabindex="-1"></a><span class="fu">## Test</span></span>
<span id="cb35-222"><a href="#cb35-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-225"><a href="#cb35-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-226"><a href="#cb35-226" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"process_data function"</span>, {</span>
<span id="cb35-227"><a href="#cb35-227" aria-hidden="true" tabindex="-1"></a>  <span class="do">## id, v1 - v4</span></span>
<span id="cb35-228"><a href="#cb35-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)],data_pro[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)])</span>
<span id="cb35-229"><a href="#cb35-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-230"><a href="#cb35-230" aria-hidden="true" tabindex="-1"></a>  <span class="do">## exposure variables</span></span>
<span id="cb35-231"><a href="#cb35-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"A"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"A1"</span>)])</span>
<span id="cb35-232"><a href="#cb35-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"Al1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"A1l1"</span>)])</span>
<span id="cb35-233"><a href="#cb35-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"Al2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"A1l2"</span>)])</span>
<span id="cb35-234"><a href="#cb35-234" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-235"><a href="#cb35-235" aria-hidden="true" tabindex="-1"></a>  <span class="do">## time-dependent covariate</span></span>
<span id="cb35-236"><a href="#cb35-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L1"</span>)])</span>
<span id="cb35-237"><a href="#cb35-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L2"</span>)])</span>
<span id="cb35-238"><a href="#cb35-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T3"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L3"</span>)])</span>
<span id="cb35-239"><a href="#cb35-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-240"><a href="#cb35-240" aria-hidden="true" tabindex="-1"></a>  <span class="do">## time-dependent covariate + lag</span></span>
<span id="cb35-241"><a href="#cb35-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T1l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L1l1"</span>)])</span>
<span id="cb35-242"><a href="#cb35-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T2l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L2l1"</span>)])</span>
<span id="cb35-243"><a href="#cb35-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T3l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L3l1"</span>)])</span>
<span id="cb35-244"><a href="#cb35-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-245"><a href="#cb35-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T1l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L1l2"</span>)])</span>
<span id="cb35-246"><a href="#cb35-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T2l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L2l2"</span>)])</span>
<span id="cb35-247"><a href="#cb35-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"T3l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"L3l2"</span>)])</span>
<span id="cb35-248"><a href="#cb35-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-249"><a href="#cb35-249" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Mediator</span></span>
<span id="cb35-250"><a href="#cb35-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"M1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"M1"</span>)])</span>
<span id="cb35-251"><a href="#cb35-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"M1l1"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"M1l1"</span>)])</span>
<span id="cb35-252"><a href="#cb35-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"M1l2"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"M1l2"</span>)])</span>
<span id="cb35-253"><a href="#cb35-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-254"><a href="#cb35-254" aria-hidden="true" tabindex="-1"></a>  <span class="do">## outcome and time</span></span>
<span id="cb35-255"><a href="#cb35-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(dat[,<span class="fu">c</span>(<span class="st">"Y"</span>,<span class="st">"j"</span>)],data_pro[,<span class="fu">c</span>(<span class="st">"Y"</span>,<span class="st">"j"</span>)])</span>
<span id="cb35-256"><a href="#cb35-256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-257"><a href="#cb35-257" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-258"><a href="#cb35-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-259"><a href="#cb35-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-260"><a href="#cb35-260" aria-hidden="true" tabindex="-1"></a><span class="fu">### Another example</span></span>
<span id="cb35-261"><a href="#cb35-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-264"><a href="#cb35-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-265"><a href="#cb35-265" aria-hidden="true" tabindex="-1"></a><span class="do">## lag = 3</span></span>
<span id="cb35-266"><a href="#cb35-266" aria-hidden="true" tabindex="-1"></a><span class="fu">process_data</span>(</span>
<span id="cb35-267"><a href="#cb35-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb35-268"><a href="#cb35-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>),</span>
<span id="cb35-269"><a href="#cb35-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb35-270"><a href="#cb35-270" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb35-271"><a href="#cb35-271" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb35-272"><a href="#cb35-272" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">3</span>,</span>
<span id="cb35-273"><a href="#cb35-273" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb35-274"><a href="#cb35-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb35-275"><a href="#cb35-275" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb35-276"><a href="#cb35-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-277"><a href="#cb35-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-278"><a href="#cb35-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-281"><a href="#cb35-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-282"><a href="#cb35-282" aria-hidden="true" tabindex="-1"></a><span class="do">## assump risk is another exposure variables</span></span>
<span id="cb35-283"><a href="#cb35-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-284"><a href="#cb35-284" aria-hidden="true" tabindex="-1"></a><span class="do">## This time, risk become A2 variable</span></span>
<span id="cb35-285"><a href="#cb35-285" aria-hidden="true" tabindex="-1"></a><span class="fu">process_data</span>(</span>
<span id="cb35-286"><a href="#cb35-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>),</span>
<span id="cb35-287"><a href="#cb35-287" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>,<span class="st">"risk"</span>),</span>
<span id="cb35-288"><a href="#cb35-288" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb35-289"><a href="#cb35-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb35-290"><a href="#cb35-290" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb35-291"><a href="#cb35-291" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb35-292"><a href="#cb35-292" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb35-293"><a href="#cb35-293" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb35-294"><a href="#cb35-294" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb35-295"><a href="#cb35-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-296"><a href="#cb35-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-297"><a href="#cb35-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-300"><a href="#cb35-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-301"><a href="#cb35-301" aria-hidden="true" tabindex="-1"></a><span class="do">## assump exposure is continuous variables, in this case is L3</span></span>
<span id="cb35-302"><a href="#cb35-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-303"><a href="#cb35-303" aria-hidden="true" tabindex="-1"></a><span class="fu">process_data</span>(</span>
<span id="cb35-304"><a href="#cb35-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb35-305"><a href="#cb35-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>,<span class="st">"L3"</span>),</span>
<span id="cb35-306"><a href="#cb35-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb35-307"><a href="#cb35-307" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>),</span>
<span id="cb35-308"><a href="#cb35-308" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb35-309"><a href="#cb35-309" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb35-310"><a href="#cb35-310" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb35-311"><a href="#cb35-311" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb35-312"><a href="#cb35-312" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb35-313"><a href="#cb35-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-314"><a href="#cb35-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-315"><a href="#cb35-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-316"><a href="#cb35-316" aria-hidden="true" tabindex="-1"></a><span class="fu"># Function to centering and scaling the time-scale variable</span></span>
<span id="cb35-317"><a href="#cb35-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-320"><a href="#cb35-320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-321"><a href="#cb35-321" aria-hidden="true" tabindex="-1"></a>cen_and_scale <span class="ot">&lt;-</span> <span class="cf">function</span>(time){</span>
<span id="cb35-322"><a href="#cb35-322" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-323"><a href="#cb35-323" aria-hidden="true" tabindex="-1"></a>  j_out <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-324"><a href="#cb35-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-325"><a href="#cb35-325" aria-hidden="true" tabindex="-1"></a>  jj <span class="ot">&lt;-</span> time <span class="sc">%&gt;%</span> </span>
<span id="cb35-326"><a href="#cb35-326" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale</span>() </span>
<span id="cb35-327"><a href="#cb35-327" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-328"><a href="#cb35-328" aria-hidden="true" tabindex="-1"></a>  j_out[[<span class="st">"jj"</span>]] <span class="ot">&lt;-</span> jj <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb35-329"><a href="#cb35-329" aria-hidden="true" tabindex="-1"></a>  j_out[[<span class="st">"mean_j"</span>]] <span class="ot">&lt;-</span> <span class="fu">attributes</span>(jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:center</span><span class="st">`</span></span>
<span id="cb35-330"><a href="#cb35-330" aria-hidden="true" tabindex="-1"></a>  j_out[[<span class="st">"sd_j"</span>]] <span class="ot">&lt;-</span> <span class="fu">attributes</span>(jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:scale</span><span class="st">`</span></span>
<span id="cb35-331"><a href="#cb35-331" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-332"><a href="#cb35-332" aria-hidden="true" tabindex="-1"></a>  j_out</span>
<span id="cb35-333"><a href="#cb35-333" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-334"><a href="#cb35-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-335"><a href="#cb35-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-336"><a href="#cb35-336" aria-hidden="true" tabindex="-1"></a>::: columns</span>
<span id="cb35-337"><a href="#cb35-337" aria-hidden="true" tabindex="-1"></a>::: {.column width="50%"}</span>
<span id="cb35-338"><a href="#cb35-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-341"><a href="#cb35-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-342"><a href="#cb35-342" aria-hidden="true" tabindex="-1"></a><span class="do">## Assump seed = 0, not doing boostrap</span></span>
<span id="cb35-343"><a href="#cb35-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-344"><a href="#cb35-344" aria-hidden="true" tabindex="-1"></a>boot <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span> </span>
<span id="cb35-345"><a href="#cb35-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb35-346"><a href="#cb35-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-347"><a href="#cb35-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_lag1 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-348"><a href="#cb35-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_lag2 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-349"><a href="#cb35-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">M_lag1 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-350"><a href="#cb35-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">M_lag2 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-351"><a href="#cb35-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1_lag1 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-352"><a href="#cb35-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">L1_lag2 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-353"><a href="#cb35-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_lag1 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb35-354"><a href="#cb35-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">L2_lag2 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb35-355"><a href="#cb35-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3_lag1 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">80</span>),</span>
<span id="cb35-356"><a href="#cb35-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">L3_lag2 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">80</span>)</span>
<span id="cb35-357"><a href="#cb35-357" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">df_prep</span>()</span>
<span id="cb35-358"><a href="#cb35-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-359"><a href="#cb35-359" aria-hidden="true" tabindex="-1"></a>boot<span class="sc">$</span>jj <span class="ot">&lt;-</span> <span class="fu">scale</span>(boot<span class="sc">$</span>j)</span>
<span id="cb35-360"><a href="#cb35-360" aria-hidden="true" tabindex="-1"></a>mean_j <span class="ot">&lt;-</span> <span class="fu">attributes</span>(boot<span class="sc">$</span>jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:center</span><span class="st">`</span></span>
<span id="cb35-361"><a href="#cb35-361" aria-hidden="true" tabindex="-1"></a>sd_j <span class="ot">&lt;-</span> <span class="fu">attributes</span>(boot<span class="sc">$</span>jj)<span class="sc">$</span><span class="st">`</span><span class="at">scaled:scale</span><span class="st">`</span></span>
<span id="cb35-362"><a href="#cb35-362" aria-hidden="true" tabindex="-1"></a>boot<span class="sc">$</span>jj <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(boot<span class="sc">$</span>jj)</span>
<span id="cb35-363"><a href="#cb35-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-364"><a href="#cb35-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-365"><a href="#cb35-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-366"><a href="#cb35-366" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-367"><a href="#cb35-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-368"><a href="#cb35-368" aria-hidden="true" tabindex="-1"></a>::: {.column width="50%"}</span>
<span id="cb35-369"><a href="#cb35-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-372"><a href="#cb35-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-373"><a href="#cb35-373" aria-hidden="true" tabindex="-1"></a>boot2 <span class="ot">&lt;-</span> <span class="fu">cen_and_scale</span>(data_pro<span class="sc">$</span>j)</span>
<span id="cb35-374"><a href="#cb35-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-375"><a href="#cb35-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-376"><a href="#cb35-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-377"><a href="#cb35-377" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-378"><a href="#cb35-378" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-379"><a href="#cb35-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-380"><a href="#cb35-380" aria-hidden="true" tabindex="-1"></a><span class="fu">### Test</span></span>
<span id="cb35-381"><a href="#cb35-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-384"><a href="#cb35-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-385"><a href="#cb35-385" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"cen and scale function"</span>, {</span>
<span id="cb35-386"><a href="#cb35-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(boot<span class="sc">$</span>jj,boot2<span class="sc">$</span>jj)</span>
<span id="cb35-387"><a href="#cb35-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(mean_j,boot2<span class="sc">$</span>mean_j)</span>
<span id="cb35-388"><a href="#cb35-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(sd_j,boot2<span class="sc">$</span>sd_j)</span>
<span id="cb35-389"><a href="#cb35-389" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-390"><a href="#cb35-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-391"><a href="#cb35-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-392"><a href="#cb35-392" aria-hidden="true" tabindex="-1"></a><span class="fu"># write formula function</span></span>
<span id="cb35-393"><a href="#cb35-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-394"><a href="#cb35-394" aria-hidden="true" tabindex="-1"></a>Assumption ở bước này là sau khi data đã được process và tên các column đã được thống nhất theo tiêu chuẩn chung của package. Khúc này em chưa viết function chỉ viết các lệnh lẻ để thể hiện workflow của function</span>
<span id="cb35-395"><a href="#cb35-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-396"><a href="#cb35-396" aria-hidden="true" tabindex="-1"></a>Em đang bị stuck ở:</span>
<span id="cb35-397"><a href="#cb35-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-398"><a href="#cb35-398" aria-hidden="true" tabindex="-1"></a><span class="ss">  -   </span>Em chưa viết được formula cho L(t), do L1 không bao gồm L2+L3, L2 thì bao gồm L1, và L3 bao gồm L1+L2. Em chưa tìm ra được quy luật để viết</span>
<span id="cb35-399"><a href="#cb35-399" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-400"><a href="#cb35-400" aria-hidden="true" tabindex="-1"></a><span class="ss">  -   </span>Phần splines phía sau sẽ để user define degree of freedom và paste vào trong formula, nhưng em chưa làm để đỡ rối  </span>
<span id="cb35-401"><a href="#cb35-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-404"><a href="#cb35-404" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-405"><a href="#cb35-405" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"A"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb35-406"><a href="#cb35-406" aria-hidden="true" tabindex="-1"></a>tf <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"v"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb35-407"><a href="#cb35-407" aria-hidden="true" tabindex="-1"></a>tva <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"L"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb35-408"><a href="#cb35-408" aria-hidden="true" tabindex="-1"></a>mediator <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"M"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb35-409"><a href="#cb35-409" aria-hidden="true" tabindex="-1"></a>outcome <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"Y"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb35-410"><a href="#cb35-410" aria-hidden="true" tabindex="-1"></a>timee <span class="ot">&lt;-</span> data_pro <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"j"</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>()</span>
<span id="cb35-411"><a href="#cb35-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-412"><a href="#cb35-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-415"><a href="#cb35-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-416"><a href="#cb35-416" aria-hidden="true" tabindex="-1"></a><span class="do">## assump các arguments này được input vào function data_processed </span></span>
<span id="cb35-417"><a href="#cb35-417" aria-hidden="true" tabindex="-1"></a>fix <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>)</span>
<span id="cb35-418"><a href="#cb35-418" aria-hidden="true" tabindex="-1"></a>expo <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Ap"</span>)</span>
<span id="cb35-419"><a href="#cb35-419" aria-hidden="true" tabindex="-1"></a>med <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Mp"</span>)</span>
<span id="cb35-420"><a href="#cb35-420" aria-hidden="true" tabindex="-1"></a>tvar <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>)</span>
<span id="cb35-421"><a href="#cb35-421" aria-hidden="true" tabindex="-1"></a>outc <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Yp"</span>)</span>
<span id="cb35-422"><a href="#cb35-422" aria-hidden="true" tabindex="-1"></a>lag <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb35-423"><a href="#cb35-423" aria-hidden="true" tabindex="-1"></a>time <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"mm"</span>)</span>
<span id="cb35-424"><a href="#cb35-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-425"><a href="#cb35-425" aria-hidden="true" tabindex="-1"></a><span class="do">## column names of exposure variables</span></span>
<span id="cb35-426"><a href="#cb35-426" aria-hidden="true" tabindex="-1"></a>name_e <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"A"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(expo))</span>
<span id="cb35-427"><a href="#cb35-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-428"><a href="#cb35-428" aria-hidden="true" tabindex="-1"></a><span class="do">## column names of mediator variables  </span></span>
<span id="cb35-429"><a href="#cb35-429" aria-hidden="true" tabindex="-1"></a>name_me <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"M"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(med))</span>
<span id="cb35-430"><a href="#cb35-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-431"><a href="#cb35-431" aria-hidden="true" tabindex="-1"></a><span class="do">## column names of time-varying variables  </span></span>
<span id="cb35-432"><a href="#cb35-432" aria-hidden="true" tabindex="-1"></a>name_tvar <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"L"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(tvar))</span>
<span id="cb35-433"><a href="#cb35-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-434"><a href="#cb35-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-435"><a href="#cb35-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-436"><a href="#cb35-436" aria-hidden="true" tabindex="-1"></a><span class="fu">## Formula for M(t)</span></span>
<span id="cb35-437"><a href="#cb35-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-440"><a href="#cb35-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-441"><a href="#cb35-441" aria-hidden="true" tabindex="-1"></a><span class="do">## formula for M(t)</span></span>
<span id="cb35-442"><a href="#cb35-442" aria-hidden="true" tabindex="-1"></a><span class="co"># l(t-1)</span></span>
<span id="cb35-443"><a href="#cb35-443" aria-hidden="true" tabindex="-1"></a>l_tm1 <span class="ot">&lt;-</span> tva[<span class="sc">!</span>tva <span class="sc">%in%</span> name_tvar]</span>
<span id="cb35-444"><a href="#cb35-444" aria-hidden="true" tabindex="-1"></a>l_tm1</span>
<span id="cb35-445"><a href="#cb35-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-446"><a href="#cb35-446" aria-hidden="true" tabindex="-1"></a>formular_mt <span class="ot">&lt;-</span> <span class="fu">paste</span>(mediator[<span class="dv">1</span>],<span class="st">"~"</span>,<span class="fu">paste</span>(<span class="fu">c</span>(eps,mediator[<span class="sc">-</span><span class="dv">1</span>],l_tm1,tf),<span class="at">collapse =</span> <span class="st">" + "</span>))</span>
<span id="cb35-447"><a href="#cb35-447" aria-hidden="true" tabindex="-1"></a>formular_mt</span>
<span id="cb35-448"><a href="#cb35-448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-449"><a href="#cb35-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-450"><a href="#cb35-450" aria-hidden="true" tabindex="-1"></a><span class="fu">### Test</span></span>
<span id="cb35-451"><a href="#cb35-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-452"><a href="#cb35-452" aria-hidden="true" tabindex="-1"></a>Assump chưa bao gồm j</span>
<span id="cb35-453"><a href="#cb35-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-456"><a href="#cb35-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-457"><a href="#cb35-457" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"test data formular for M(t)"</span>, {</span>
<span id="cb35-458"><a href="#cb35-458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-459"><a href="#cb35-459" aria-hidden="true" tabindex="-1"></a>  <span class="do">## a Long code</span></span>
<span id="cb35-460"><a href="#cb35-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-461"><a href="#cb35-461" aria-hidden="true" tabindex="-1"></a>  boot <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span> </span>
<span id="cb35-462"><a href="#cb35-462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb35-463"><a href="#cb35-463" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-464"><a href="#cb35-464" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag1 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-465"><a href="#cb35-465" aria-hidden="true" tabindex="-1"></a>      <span class="at">A_lag2 =</span> <span class="fu">lag</span>(Ap, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-466"><a href="#cb35-466" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag1 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-467"><a href="#cb35-467" aria-hidden="true" tabindex="-1"></a>      <span class="at">M_lag2 =</span> <span class="fu">lag</span>(Mp, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-468"><a href="#cb35-468" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag1 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-469"><a href="#cb35-469" aria-hidden="true" tabindex="-1"></a>      <span class="at">L1_lag2 =</span> <span class="fu">lag</span>(L1, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb35-470"><a href="#cb35-470" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag1 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb35-471"><a href="#cb35-471" aria-hidden="true" tabindex="-1"></a>      <span class="at">L2_lag2 =</span> <span class="fu">lag</span>(L2, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">100</span>),</span>
<span id="cb35-472"><a href="#cb35-472" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag1 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">80</span>),</span>
<span id="cb35-473"><a href="#cb35-473" aria-hidden="true" tabindex="-1"></a>      <span class="at">L3_lag2 =</span> <span class="fu">lag</span>(L3, <span class="at">n =</span> <span class="dv">2</span>, <span class="at">default =</span> <span class="dv">80</span>)</span>
<span id="cb35-474"><a href="#cb35-474" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">df_prep</span>()</span>
<span id="cb35-475"><a href="#cb35-475" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-476"><a href="#cb35-476" aria-hidden="true" tabindex="-1"></a>  aLong_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(M1 <span class="sc">~</span> A <span class="sc">+</span> Al1 <span class="sc">+</span> Al2 <span class="sc">+</span> M1l1 <span class="sc">+</span> M1l2 <span class="sc">+</span> T1l1 <span class="sc">+</span> T1l2 <span class="sc">+</span> T2l1 <span class="sc">+</span> T2l2 <span class="sc">+</span> T3l1 <span class="sc">+</span> T3l2 <span class="sc">+</span> </span>
<span id="cb35-477"><a href="#cb35-477" aria-hidden="true" tabindex="-1"></a>                      v1 <span class="sc">+</span> v2 <span class="sc">+</span> v3 <span class="sc">+</span> v4, <span class="at">family =</span> binomial, <span class="at">data =</span> boot)<span class="sc">|&gt;</span></span>
<span id="cb35-478"><a href="#cb35-478" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb35-479"><a href="#cb35-479" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-480"><a href="#cb35-480" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Nguyen's code</span></span>
<span id="cb35-481"><a href="#cb35-481" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-482"><a href="#cb35-482" aria-hidden="true" tabindex="-1"></a>  data_pro <span class="ot">&lt;-</span> <span class="fu">process_data</span>(</span>
<span id="cb35-483"><a href="#cb35-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">fix =</span> <span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"sex"</span>,<span class="st">"ow"</span>,<span class="st">"risk"</span>),</span>
<span id="cb35-484"><a href="#cb35-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">expo =</span> <span class="fu">c</span>(<span class="st">"Ap"</span>),</span>
<span id="cb35-485"><a href="#cb35-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">med =</span> <span class="fu">c</span>(<span class="st">"Mp"</span>),</span>
<span id="cb35-486"><a href="#cb35-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">tvar =</span> <span class="fu">c</span>(<span class="st">"L1"</span>,<span class="st">"L2"</span>,<span class="st">"L3"</span>),</span>
<span id="cb35-487"><a href="#cb35-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">outc =</span> <span class="fu">c</span>(<span class="st">"Yp"</span>),</span>
<span id="cb35-488"><a href="#cb35-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag =</span> <span class="dv">2</span>,</span>
<span id="cb35-489"><a href="#cb35-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">"mm"</span>),</span>
<span id="cb35-490"><a href="#cb35-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat0</span>
<span id="cb35-491"><a href="#cb35-491" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb35-492"><a href="#cb35-492" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-493"><a href="#cb35-493" aria-hidden="true" tabindex="-1"></a>  N_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(formular_mt ,<span class="at">family =</span> binomial, <span class="at">data =</span> data_pro) <span class="sc">|&gt;</span></span>
<span id="cb35-494"><a href="#cb35-494" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb35-495"><a href="#cb35-495" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-496"><a href="#cb35-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">min</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">min</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb35-497"><a href="#cb35-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">max</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">max</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb35-498"><a href="#cb35-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">mean</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">mean</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb35-499"><a href="#cb35-499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">sd</span>(N_model<span class="sc">$</span>fitted.values),<span class="fu">sd</span>(aLong_model<span class="sc">$</span>fitted.values))</span>
<span id="cb35-500"><a href="#cb35-500" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-501"><a href="#cb35-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-502"><a href="#cb35-502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-503"><a href="#cb35-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-504"><a href="#cb35-504" aria-hidden="true" tabindex="-1"></a><span class="fu">## formula for Y</span></span>
<span id="cb35-505"><a href="#cb35-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-508"><a href="#cb35-508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-509"><a href="#cb35-509" aria-hidden="true" tabindex="-1"></a>formular_y <span class="ot">&lt;-</span> <span class="fu">paste</span>(outcome,<span class="st">"~"</span>,<span class="fu">paste</span>(<span class="fu">c</span>(eps,mediator,tva,tf),<span class="at">collapse =</span> <span class="st">" + "</span>))</span>
<span id="cb35-510"><a href="#cb35-510" aria-hidden="true" tabindex="-1"></a>formular_y</span>
<span id="cb35-511"><a href="#cb35-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-512"><a href="#cb35-512" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"test data formular for Y"</span>, {</span>
<span id="cb35-513"><a href="#cb35-513" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-514"><a href="#cb35-514" aria-hidden="true" tabindex="-1"></a>  N_model_y <span class="ot">&lt;-</span> <span class="fu">glm</span>(formular_y ,<span class="at">family =</span> binomial, <span class="at">data =</span> data_pro) <span class="sc">|&gt;</span></span>
<span id="cb35-515"><a href="#cb35-515" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb35-516"><a href="#cb35-516" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-517"><a href="#cb35-517" aria-hidden="true" tabindex="-1"></a>  aLong_model_y <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> A <span class="sc">+</span> Al1 <span class="sc">+</span> Al2 <span class="sc">+</span> M1 <span class="sc">+</span> M1l1 <span class="sc">+</span> M1l2 <span class="sc">+</span> T1 <span class="sc">+</span> T1l1 <span class="sc">+</span> T1l2 <span class="sc">+</span> T2 <span class="sc">+</span> T2l1 <span class="sc">+</span> T2l2 <span class="sc">+</span> </span>
<span id="cb35-518"><a href="#cb35-518" aria-hidden="true" tabindex="-1"></a>                       T3 <span class="sc">+</span> T3l1 <span class="sc">+</span> T3l2 <span class="sc">+</span>  v1 <span class="sc">+</span> v2 <span class="sc">+</span> v3 <span class="sc">+</span> v4, </span>
<span id="cb35-519"><a href="#cb35-519" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family =</span> binomial, <span class="at">data =</span> boot) <span class="sc">|&gt;</span></span>
<span id="cb35-520"><a href="#cb35-520" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>()</span>
<span id="cb35-521"><a href="#cb35-521" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-522"><a href="#cb35-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">min</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">min</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb35-523"><a href="#cb35-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">max</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">max</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb35-524"><a href="#cb35-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">mean</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">mean</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb35-525"><a href="#cb35-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">sd</span>(N_model_y<span class="sc">$</span>fitted.values),<span class="fu">sd</span>(aLong_model_y<span class="sc">$</span>fitted.values))</span>
<span id="cb35-526"><a href="#cb35-526" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-527"><a href="#cb35-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-528"><a href="#cb35-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-529"><a href="#cb35-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-530"><a href="#cb35-530" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>